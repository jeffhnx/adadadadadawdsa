-- ESP + Aimbot Script for Roblox (Highlight enemies in red, teammates in green, and track closest player's head to the center of the screen)

local ESP = {}
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local camera = game:GetService("Workspace").CurrentCamera
local userInputService = game:GetService("UserInputService")
local localPlayer = players.LocalPlayer
local holdingRightClick = false
local espEnabled = true -- ESP initially enabled

-- Customize the ESP colors
ESP.TeamColor = Color3.new(0, 1, 0)  -- Green for teammates
ESP.EnemyColor = Color3.new(1, 0, 0) -- Red for enemies

-- Function to create ESP for a player
function CreateESP(player)
    local highlight = Instance.new("Highlight")
    highlight.Parent = player.Character
    highlight.Adornee = player.Character
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0.5

    -- Team check
    if player.Team == localPlayer.Team then
        highlight.FillColor = ESP.TeamColor -- Green for teammates
    else
        highlight.FillColor = ESP.EnemyColor -- Red for enemies
    end
end

-- Function to remove ESP when player dies or leaves
function RemoveESP(player)
    if player.Character then
        for _, v in pairs(player.Character:GetChildren()) do
            if v:IsA("Highlight") then
                v:Destroy()
            end
        end
    end
end

-- Toggle ESP on or off by destroying/adding highlights
function ToggleESP(enabled)
    for _, player in pairs(players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            if enabled then
                CreateESP(player) -- Add ESP if enabled
            else
                RemoveESP(player) -- Remove ESP if disabled
            end
        end
    end
end

-- Function to calculate screen distance (2D) from center of the screen to a player's head
function GetScreenDistanceFromCenter(player)
    if player.Character and player.Character:FindFirstChild("Head") then
        local headPosition = camera:WorldToViewportPoint(player.Character.Head.Position)
        local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
        local headOnScreen = Vector2.new(headPosition.X, headPosition.Y)
        local distanceFromCenter = (screenCenter - headOnScreen).Magnitude
        return distanceFromCenter
    end
    return math.huge -- Return a large value if no valid head is found
end

-- Function to find the closest enemy to the center of the screen
function GetClosestEnemy()
    local closestEnemy = nil
    local closestDistance = math.huge

    for _, player in pairs(players:GetPlayers()) do
        if player ~= localPlayer and player.Team ~= localPlayer.Team and player.Character and player.Character:FindFirstChild("Head") then
            local distanceFromCenter = GetScreenDistanceFromCenter(player)
            if distanceFromCenter < closestDistance then
                closestDistance = distanceFromCenter
                closestEnemy = player
            end
        end
    end

    return closestEnemy
end

-- Function to aim at a player's head
function AimAtHead(player)
    if player and player.Character and player.Character:FindFirstChild("Head") then
        local head = player.Character.Head
        -- Adjust the camera CFrame to aim at the player's head
        local aimPosition = head.Position + Vector3.new(0, 0.5, 0) -- Adjust for head height
        camera.CFrame = CFrame.new(camera.CFrame.Position, aimPosition)
    end
end

-- Apply ESP to existing players
for _, player in pairs(players:GetPlayers()) do
    if player ~= localPlayer and player.Character then
        CreateESP(player)
        -- Remove ESP when player dies
        player.CharacterRemoving:Connect(function()
            RemoveESP(player)
        end)
    end
end

-- Apply ESP to newly joining players
players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if espEnabled then
            CreateESP(player)
        end
    end)
end)

-- Aimbot: Track the closest player's head to the center of the screen when holding right mouse button
userInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then -- Right Mouse Button
        holdingRightClick = true
    elseif input.KeyCode == Enum.KeyCode.F then -- F key to toggle ESP
        espEnabled = not espEnabled
        ToggleESP(espEnabled)
    end
end)

userInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then -- Right Mouse Button
        holdingRightClick = false
    end
end)

-- Main loop to aim at the closest enemy when right-click is held
runService.RenderStepped:Connect(function()
    if holdingRightClick then
        local closestEnemy = GetClosestEnemy()
        if closestEnemy then
            AimAtHead(closestEnemy)
        end
    end
end)

-- Update ESP during runtime if it's enabled
runService.RenderStepped:Connect(function()
    if espEnabled then
        for _, player in pairs(players:GetPlayers()) do
            if player ~= localPlayer and player.Character then
                CreateESP(player)
            end
        end
    end
end)
